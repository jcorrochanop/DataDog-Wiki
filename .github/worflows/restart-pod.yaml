name: Restart Kubernetes Pod

on:
  repository_dispatch:
    types: [restart-pod]

jobs:
  restart-pod:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup gcloud CLI
        uses: google-github-actions/setup-gcloud@v2
      
      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
      
      - name: Get GKE cluster credentials
        run: |
          gcloud container clusters get-credentials autopilot-cluster-1 \
            --region=europe-west1 \
            --project=balmy-mile-452912-p6
      
      - name: Show alert information
        run: |
          echo "ğŸš¨ Alerta recibida desde Datadog"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“‹ TÃ­tulo: ${{ github.event.client_payload.alert_title }}"
          echo "ğŸ“Š Estado: ${{ github.event.client_payload.alert_status }}"
          echo "ğŸ·ï¸  Cluster: ${{ github.event.client_payload.cluster }}"
          echo "ğŸ“¦ Pod: ${{ github.event.client_payload.pod_name }}"
          echo "ğŸ—‚ï¸  Namespace: ${{ github.event.client_payload.namespace }}"
          echo "ğŸš€ Deployment: ${{ github.event.client_payload.deployment }}"
          echo "ğŸ†” Alert ID: ${{ github.event.client_payload.alert_id }}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      
      - name: Restart deployment
        run: |
          NAMESPACE="${{ github.event.client_payload.namespace }}"
          DEPLOYMENT="${{ github.event.client_payload.deployment }}"
          POD_NAME="${{ github.event.client_payload.pod_name }}"
          
          if [ -n "$DEPLOYMENT" ] && [ "$DEPLOYMENT" != "null" ]; then
            echo "ğŸ”„ Reiniciando deployment: $DEPLOYMENT en namespace: $NAMESPACE"
            kubectl rollout restart deployment/$DEPLOYMENT -n $NAMESPACE
            echo "âœ… Deployment reiniciado exitosamente"
          elif [ -n "$POD_NAME" ] && [ "$POD_NAME" != "null" ]; then
            echo "ğŸ—‘ï¸  Eliminando pod: $POD_NAME en namespace: $NAMESPACE"
            kubectl delete pod $POD_NAME -n $NAMESPACE --grace-period=30
            echo "âœ… Pod eliminado (se recrearÃ¡ automÃ¡ticamente)"
          else
            echo "âš ï¸  No se pudo identificar deployment o pod para reiniciar"
            exit 1
          fi
      
      - name: Wait for rollout to complete
        if: github.event.client_payload.deployment != '' && github.event.client_payload.deployment != 'null'
        run: |
          NAMESPACE="${{ github.event.client_payload.namespace }}"
          DEPLOYMENT="${{ github.event.client_payload.deployment }}"
          
          echo "â³ Esperando que el rollout complete..."
          kubectl rollout status deployment/$DEPLOYMENT -n $NAMESPACE --timeout=5m
      
      - name: Verify pods are running
        run: |
          NAMESPACE="${{ github.event.client_payload.namespace }}"
          
          echo "ğŸ“‹ Estado actual de los pods en namespace $NAMESPACE:"
          kubectl get pods -n $NAMESPACE
